// JSLitmus.js
//
// History:
//   2008-10-27: Initial release
//   2008-11-09: Account for iteration loop overhead
//   2008-11-13: Added OS detection
//   2009-02-25: Create tinyURL automatically, shift-click runs tests in reverse
//
// Copyright (c) 2008-2009, Robert Kieffer
// All Rights Reserved
//
// Permission is hereby granted, free of charge, to any person obtaining a copy
// of this software and associated documentation files (the
// Software), to deal in the Software without restriction, including
// without limitation the rights to use, copy, modify, merge, publish,
// distribute, sublicense, and/or sell copies of the Software, and to permit
// persons to whom the Software is furnished to do so, subject to the
// following conditions:
//
// THE SOFTWARE IS PROVIDED AS IS, WITHOUT WARRANTY OF ANY KIND,
// EXPRESS OR IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF
// MERCHANTABILITY, FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN
// NO EVENT SHALL THE AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM,
// DAMAGES OR OTHER LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR
// OTHERWISE, ARISING FROM, OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE
// USE OR OTHER DEALINGS IN THE SOFTWARE.

(function(){var e="unknown platform",t=navigator.userAgent,n=["Windows","iPhone OS","(Intel |PPC )?Mac OS X","Linux"].join("|"),r=(new RegExp("(("+n+") [^ );]*)")).test(t)?RegExp.$1:null;r||(r=(new RegExp("(("+n+")[^ );]*)")).test(t)?RegExp.$1:null);var i=/(Chrome|MSIE|Safari|Opera|Firefox)/.test(t)?RegExp.$1:null,s=new RegExp("(Version|"+i+")[ /]([^ ;]*)"),o=i&&s.test(t)?RegExp.$2:null,e=r&&i&&o?i+" "+o+" on "+r:"unknown platform",u={escape:function(e){return e=e.replace(/,/g,"\\,"),e=escape(e),e=e.replace(/\+/g,"%2b"),e=e.replace(/ /g,"+"),e},$:function(e){return document.getElementById(e)},F:function(){},status:function(e){var t=u.$("jsl_status");t&&(t.innerHTML=e||"")},toLabel:function(e){return e==Infinity?"Infinity":e>1e9?(e=Math.round(e/1e8),e/10+"B"):e>1e6?(e=Math.round(e/1e5),e/10+"M"):e>1e3?(e=Math.round(e/100),e/10+"K"):e},extend:function(e,t){for(var n in t)e[n]=t[n];return e},join:function(e,t,n){if(e.join)return e.join(t);var r=[];for(var i in e)r.push(i+t+e[i]);return r.join(n)},indexOf:function(e,t){if(e.indexOf)return e.indexOf(t);for(var n=0;n<this.length;n++)if(e[n]===t)return n;return-1}},a=function(e,t){if(!t)throw new Error("Undefined test function");if(!/function[^\(]*\(([^,\)]*)/.test(t.toString()))throw new Error('"'+e+'" test: Test is not a valid Function object');this.loopArg=RegExp.$1,this.name=e,this.f=t};u.extend(a,{CALIBRATIONS:[new a("calibrating loop",function(e){while(e--);}),new a("calibrating function",u.F)],calibrate:function(e){for(var t=0;t<a.CALIBRATIONS.length;t++){var n=a.CALIBRATIONS[t];if(n.running)return!0;if(!n.count)return n.isCalibration=!0,n.onStop=e,n.run(2e4),!0}return!1}}),u.extend(a.prototype,{INIT_COUNT:10,MAX_COUNT:1e9,MIN_TIME:.5,onChange:u.F,onStop:u.F,reset:function(){delete this.count,delete this.time,delete this.running,delete this.error},run:function(e){e=e||this.INIT_COUNT,u.status(this.name+" x "+e),this.running=!0;var t=this;setTimeout(function(){t._run(e)},200)},_run:function(e){var t=this;if(!t.isCalibration&&a.calibrate(function(){t.run(e)}))return;this.error=null;try{var n,r=this.f,i,s=e;n=new Date;if(this.loopArg)r(e);else while(s--)r();this.time=Math.max(1,new Date-n)/1e3,this.count=e,this.period=this.time/e,this.running=this.time<=this.MIN_TIME;if(this.running){var o=this.MIN_TIME/this.time,f=Math.pow(2,Math.max(1,Math.ceil(Math.log(o)/Math.log(2))));e*=f;if(e>this.MAX_COUNT)throw new Error("Max count exceeded.  If this test uses a looping function, make sure the iteration loop is working properly.")}}catch(l){this.reset(),this.error=l}this.running?t.run(e):(u.status(""),t.onStop(t)),this.onChange(this)},getHz:function(e){var t=this.period;if(e&&!this.isCalibration){var n=a.CALIBRATIONS[this.loopArg?0:1];t=t<n.period*1.2?0:t-n.period}return Math.round(1/t)},toString:function(){return this.name+" - "+this.time/this.count+" secs"}});var f="<style>     #jslitmus {font-family:sans-serif; font-size: 12px;}     #jslitmus a {text-decoration: none;}     #jslitmus a:hover {text-decoration: underline;}     #jsl_status {       margin-top: 10px;       font-size: 10px;       color: #888;     }     A IMG  {border:none}     #test_results {       margin-top: 10px;       font-size: 12px;       font-family: sans-serif;       border-collapse: collapse;       border-spacing: 0px;     }     #test_results th, #test_results td {       border: solid 1px #ccc;       vertical-align: top;       padding: 3px;     }     #test_results th {       vertical-align: bottom;       background-color: #ccc;       padding: 1px;       font-size: 10px;     }     #test_results #test_platform {       color: #444;       text-align:center;     }     #test_results .test_row {       color: #006;       cursor: pointer;     }     #test_results .test_nonlooping {       border-left-style: dotted;       border-left-width: 2px;     }     #test_results .test_looping {       border-left-style: solid;       border-left-width: 2px;     }     #test_results .test_name {white-space: nowrap;}     #test_results .test_pending {     }     #test_results .test_running {       font-style: italic;     }     #test_results .test_done {}     #test_results .test_done {       text-align: right;       font-family: monospace;     }     #test_results .test_error {color: #600;}     #test_results .test_error .error_head {font-weight:bold;}     #test_results .test_error .error_body {font-size:85%;}     #test_results .test_row:hover td {       background-color: #ffc;       text-decoration: underline;     }     #chart {       margin: 10px 0px;       width: 250px;     }     #chart img {       border: solid 1px #ccc;       margin-bottom: 5px;     }     #chart #tiny_url {       height: 40px;       width: 250px;     }     #jslitmus_credit {       font-size: 10px;       color: #888;       margin-top: 8px;     }     </style>",l='<div id="jslitmus">       <button onclick="JSLitmus.runAll(event)">Run Tests</button>       <button id="stop_button" disabled="disabled" onclick="JSLitmus.stop()">Stop Tests</button>       <br >       <br >       <input type="checkbox" style="vertical-align: middle" id="test_normalize" checked="checked" onchange="JSLitmus.renderAll()""> Normalize results       <table id="test_results">         <colgroup>           <col />           <col width="100" />         </colgroup>         <tr><th id="test_platform" colspan="2">'+e+'</th></tr>         <tr><th>Test</th><th>Ops/sec</th></tr>         <tr id="test_row_template" class="test_row" style="display:none">           <td class="test_name"></td>           <td class="test_result">Ready</td>         </tr>       </table>       <div id="jsl_status"></div>       <div id="chart" style="display:none">       <a id="chart_link" target="_blank"><img id="chart_image"></a>       TinyURL (for chart):       <iframe id="tiny_url" frameBorder="0" scrolling="no" src=""></iframe>       </div>       <a id="jslitmus_credit" title="JSLitmus home page" href="http://code.google.com/p/jslitmus" target="_blank">Powered by JSLitmus</a>     </div>';window.JSLitmus={_tests:[],_queue:[],params:{},_init:function(){var e=(location+"").match(/([^?#]*)(#.*)?$/);if(e){var t=e[1].split("&");for(var n=0;n<t.length;n++){var r=t[n].split("=");if(r.length>1){var i=r.shift(),s=r.length>1?r.join("="):r[0];this.params[i]=s}}}return document.write(f),window.addEventListener?window.addEventListener("load",this._setup,!1):document.addEventListener?document.addEventListener("load",this._setup,!1):window.attachEvent&&window.attachEvent("onload",this._setup),this},_setup:function(){var e=u.$("jslitmus_container");e||document.body.appendChild(e=document.createElement("div")),e.innerHTML=l;for(var t=0;t<JSLitmus._tests.length;t++)JSLitmus.renderTest(JSLitmus._tests[t])},renderAll:function(){for(var e=0;e<JSLitmus._tests.length;e++)JSLitmus.renderTest(JSLitmus._tests[e]);JSLitmus.renderChart()},renderChart:function(){var e=JSLitmus.chartUrl();u.$("chart_link").href=e,u.$("chart_image").src=e,u.$("chart").style.display="",u.$("tiny_url").src="http://tinyurl.com/api-create.php?url="+escape(e)},renderTest:function(e){if(!e._row){var t=u.$("test_row_template");if(!t)return;e._row=t.cloneNode(!0),e._row.style.display="",e._row.id="",e._row.onclick=function(){JSLitmus._queueTest(e)},e._row.title="Run "+e.name+" test",t.parentNode.appendChild(e._row),e._row.cells[0].innerHTML=e.name}var n=e._row.cells[1],r=[e.loopArg?"test_looping":"test_nonlooping"];if(e.error)r.push("test_error"),n.innerHTML='<div class="error_head">'+e.error+"</div>"+'<ul class="error_body"><li>'+u.join(e.error,": ","</li><li>")+"</li></ul>";else if(e.running)r.push("test_running"),n.innerHTML="running";else if(u.indexOf(JSLitmus._queue,e)>=0)r.push("test_pending"),n.innerHTML="pending";else if(e.count){r.push("test_done");var i=e.getHz(u.$("test_normalize").checked);n.innerHTML=i!=Infinity?i:"&infin;"}else n.innerHTML="ready";n.className=r.join(" ")},test:function(e,t){var n=new a(e,t);JSLitmus._tests.push(n),n.onChange=JSLitmus.renderTest,n.onStop=function(e){JSLitmus.onTestFinish&&JSLitmus.onTestFinish(e),JSLitmus.currentTest=null,JSLitmus._nextTest()},this.renderTest(n)},runAll:function(e){e=e||window.event;var t=e&&e.shiftKey,n=JSLitmus._tests.length;for(var r=0;r<n;r++)JSLitmus._queueTest(JSLitmus._tests[t?n-r-1:r])},stop:function(){while(JSLitmus._queue.length){var e=JSLitmus._queue.shift();JSLitmus.renderTest(e)}},_nextTest:function(){if(!JSLitmus.currentTest){var e=JSLitmus._queue.shift();e?(u.$("stop_button").disabled=!1,JSLitmus.currentTest=e,e.run(),JSLitmus.renderTest(e),JSLitmus.onTestStart&&JSLitmus.onTestStart(e)):(u.$("stop_button").disabled=!0,JSLitmus.renderChart())}},_queueTest:function(e){if(u.indexOf(JSLitmus._queue,e)>=0)return;JSLitmus._queue.push(e),JSLitmus.renderTest(e),JSLitmus._nextTest()},chartUrl:function(){var t=JSLitmus._tests.length,n=[],r=[],i,s=0,o=-1e10,a=u.$("test_normalize").checked;for(var f=0;f<JSLitmus._tests.length;f++){var l=JSLitmus._tests[f];if(l.count){var c=l.getHz(a),h=c!=Infinity?c:0;r.push(h),n.push("t"+u.escape(l.name+"("+u.toLabel(c)+")")+",000000,0,"+n.length+",10"),o=Math.max(h,o)}}if(n.length<=0)return null;var p=document.getElementsByTagName("title");p=p&&p.length?p[0].innerHTML:null;var d=[];p&&d.push(p),d.push("Ops/sec ("+e+")");var v=[u.toLabel(s),u.toLabel(o)],m=250,g=15,y=5,b=n.length*(g+y)+30+d.length*20,w={chtt:escape(d.join("|")),chts:"000000,10",cht:"bhg",chd:"t:"+r.join(","),chds:s+","+o,chxt:"x",chxl:"0:|"+v.join("|"),chsp:"0,1",chm:n.join("|"),chbh:[g,0,y].join(","),chs:m+"x"+b};return"http://chart.apis.google.com/chart?"+u.join(w,"=","&")}},JSLitmus._init()})();