/*! Copyright (c) 2011, Lloyd Hilaiel, ISC License */

(function(e){function n(e){try{return JSON&&JSON.parse?JSON.parse(e):(new Function("return "+e))()}catch(t){i("ijs")}}function i(e){throw new Error(r[e])}function c(e){return Array.isArray?Array.isArray(e):t.call(e)==="[object Array]"}function h(e){if(e===null)return"null";var t=typeof e;return t==="object"&&c(e)&&(t="array"),t}function p(e,t,n,r,i){var s=[],o=t[0]===">"?t[1]:t[0],u=!0,a;return o.type&&(u=u&&o.type===h(e)),o.id&&(u=u&&o.id===n),u&&o.pf&&(o.pf===":nth-last-child"?r=i-r:r++,o.a===0?u=o.b===r:(a=(r-o.b)%o.a,u=!a&&r*o.a+o.b>=0)),t[0]!==">"&&t[0].pc!==":root"&&s.push(t),u&&(t[0]===">"?t.length>2&&(u=!1,s.push(t.slice(2))):t.length>1&&(u=!1,s.push(t.slice(1)))),[u,s]}function d(e,t,n,r,i,s){var o=e[0]===","?e.slice(1):[e],u=[],a=!1,f=0,l=0,h=0,v,m;for(f=0;f<o.length;f++){m=p(t,o[f],r,i,s),m[0]&&(a=!0);for(l=0;l<m[1].length;l++)u.push(m[1][l])}if(u.length&&typeof t=="object"){u.length>=1&&u.unshift(",");if(c(t))for(f=0;f<t.length;f++)d(u,t[f],n,undefined,f,t.length);else{h=0;for(v in t)t.hasOwnProperty(v)&&h++;f=0;for(v in t)t.hasOwnProperty(v)&&d(u,t[v],n,v,f++,h)}}a&&n&&n(t)}function v(e,t){var n=[];return d(e,t,function(e){n.push(e)}),n}function m(e){return{sel:f(e),match:function(e){return v(this.sel,e)},forEach:function(e,t){return d(this.sel,e,t)}}}var t=Object.prototype.toString,r={ijs:"invalid json string",mpc:"multiple pseudo classes (:xxx) not allowed",mepf:"malformed expression in pseudo-function",nmi:"multiple ids not allowed",se:"selector expected",sra:"string required after '.'",uc:"unrecognized char",ujs:"unclosed json string",upc:"unrecognized pseudo class"},s={psc:1,psf:2,typ:3,str:4},o=/^(?:([\r\n\t\ ]+)|([*.,>])|(string|boolean|null|array|object|number)|(:(?:root|first-child|last-child|only-child))|(:(?:nth-child|nth-last-child))|(:\w+)|(\"(?:[^\\]|\\[^\"])*\")|(\")|((?:[_a-zA-Z]|[^\0-\0177]|\\[^\r\n\f0-9a-fA-F])(?:[_a-zA-Z0-9\-]|[^\u0000-\u0177]|(?:\\[^\r\n\f0-9a-fA-F]))*))/,u=/^\s*\(\s*(?:([+\-]?)([0-9]*)n\s*(?:([+\-])\s*([0-9]))?|(odd|even)|([+\-]?[0-9]+))\s*\)/,a=function(e,t){t||(t=0);var r=o.exec(e.substr(t));if(!r)return undefined;t+=r[0].length;var u;return r[1]?u=[t," "]:r[2]?u=[t,r[0]]:r[3]?u=[t,s.typ,r[0]]:r[4]?u=[t,s.psc,r[0]]:r[5]?u=[t,s.psf,r[0]]:r[6]?i("upc"):r[7]?u=[t,s.str,n(r[0])]:r[8]?i("ujs"):r[9]&&(u=[t,s.str,r[0].replace(/\\([^\r\n\f0-9a-fA-F])/g,"$1")]),u},f=function(e){var t=[],n=0,r;for(;;){var i=l(e,n);t.push(i[1]),i=a(e,n=i[0]),i&&i[1]===" "&&(i=a(e,n=i[0]));if(!i)break;i[1]===">"?(t.push(">"),n=i[0]):i[1]===","&&(r===undefined?r=[",",t]:r.push(t),t=[],n=i[0])}return r&&r.push(t),r?r:t},l=function(e,t){var n=t,r={},o=a(e,t);o&&o[1]===" "&&(n=t=o[0],o=a(e,t)),o&&o[1]===s.typ?(r.type=o[2],o=a(e,t=o[0])):o&&o[1]==="*"&&(o=a(e,t=o[0]));for(;;){if(o===undefined)break;if(o[1]===".")o=a(e,t=o[0]),(!o||o[1]!==s.str)&&i("sra"),r.id&&i("nmi"),r.id=o[2];else if(o[1]===s.psc)(r.pc||r.pf)&&i("mpc"),o[2]===":first-child"?(r.pf=":nth-child",r.a=0,r.b=1):o[2]===":last-child"?(r.pf=":nth-last-child",r.a=0,r.b=1):r.pc=o[2];else{if(o[1]!==s.psf)break;(r.pc||r.pf)&&i("mpc"),r.pf=o[2];var f=u.exec(e.substr(o[0]));f||i("mepf"),f[5]?(r.a=2,r.b=f[5]==="odd"?1:0):f[6]?(r.a=0,r.b=parseInt(f[6],10)):(r.a=parseInt((f[1]?f[1]:"+")+(f[2]?f[2]:"1"),10),r.b=f[3]?parseInt(f[3]+f[4],10):0),o[0]+=f[0].length}o=a(e,t=o[0])}return n===t&&i("se"),[t,r]};e._lex=a,e._parse=f,e.match=function(e,t){return m(e).match(t)},e.forEach=function(e,t,n){return m(e).forEach(t,n)},e.compile=m})(typeof exports=="undefined"?window.JSONSelect={}:exports);