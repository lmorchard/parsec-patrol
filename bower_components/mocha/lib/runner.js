function Runner(e){var t=this;this._globals=[],this.suite=e,this.total=e.total(),this.failures=0,this.on("test end",function(e){t.checkGlobals(e)}),this.on("hook end",function(e){t.checkGlobals(e)}),this.grep(/.*/),this.globals(this.globalProps().concat(["errno"]))}function filterLeaks(e,t){return filter(t,function(t){var n=filter(e,function(e){return~e.indexOf("*")?0==t.indexOf(e.split("*")[0]):/^mocha-/.test(t)?!0:t==e});return n.length==0&&(!global.navigator||"onerror"!==t)})}var EventEmitter=require("events").EventEmitter,debug=require("debug")("mocha:runner"),Test=require("./test"),utils=require("./utils"),filter=utils.filter,keys=utils.keys,globals=["setTimeout","clearTimeout","setInterval","clearInterval","XMLHttpRequest","Date"];module.exports=Runner,Runner.immediately=global.setImmediate||process.nextTick,Runner.prototype.__proto__=EventEmitter.prototype,Runner.prototype.grep=function(e,t){return debug("grep %s",e),this._grep=e,this._invert=t,this.total=this.grepTotal(this.suite),this},Runner.prototype.grepTotal=function(e){var t=this,n=0;return e.eachTest(function(e){var r=t._grep.test(e.fullTitle());t._invert&&(r=!r),r&&n++}),n},Runner.prototype.globalProps=function(){var e=utils.keys(global);for(var t=0;t<globals.length;++t){if(~utils.indexOf(e,globals[t]))continue;e.push(globals[t])}return e},Runner.prototype.globals=function(e){return 0==arguments.length?this._globals:(debug("globals %j",e),utils.forEach(e,function(e){this._globals.push(e)},this),this)},Runner.prototype.checkGlobals=function(e){if(this.ignoreLeaks)return;var t=this._globals,n=this.globalProps(),r=process.kill,i;if(r&&1==t.length-n.length)return;if(2==t.length-n.length)return;i=filterLeaks(t,n),this._globals=this._globals.concat(i),i.length>1?this.fail(e,new Error("global leaks detected: "+i.join(", ")+"")):i.length&&this.fail(e,new Error("global leak detected: "+i[0]))},Runner.prototype.fail=function(e,t){++this.failures,e.state="failed","string"==typeof t&&(t=new Error('the string "'+t+'" was thrown, throw an Error :)')),this.emit("fail",e,t)},Runner.prototype.failHook=function(e,t){this.fail(e,t),this.emit("end")},Runner.prototype.hook=function(e,t){function o(e){var n=r[e];if(!n)return t();i.currentRunnable=n,i.emit("hook",n),n.on("error",function(e){i.failHook(n,e)}),n.run(function(t){n.removeAllListeners("error");var r=n.error();r&&i.fail(i.test,r);if(t)return i.failHook(n,t);i.emit("hook end",n),o(++e)})}var n=this.suite,r=n["_"+e],i=this,s;Runner.immediately(function(){o(0)})},Runner.prototype.hooks=function(e,t,n){function s(o){r.suite=o;if(!o)return r.suite=i,n();r.hook(e,function(e){if(e)return r.suite=i,n(e);s(t.pop())})}var r=this,i=this.suite;s(t.pop())},Runner.prototype.hookUp=function(e,t){var n=[this.suite].concat(this.parents()).reverse();this.hooks(e,n,t)},Runner.prototype.hookDown=function(e,t){var n=[this.suite].concat(this.parents());this.hooks(e,n,t)},Runner.prototype.parents=function(){var e=this.suite,t=[];while(e=e.parent)t.push(e);return t},Runner.prototype.runTest=function(e){var t=this.test,n=this;this.asyncOnly&&(t.asyncOnly=!0);try{t.on("error",function(e){n.fail(t,e)}),t.run(e)}catch(r){e(r)}},Runner.prototype.runTests=function(e,t){function s(o){if(n.failures&&e._bail)return t();i=r.shift();if(!i)return t();var u=n._grep.test(i.fullTitle());n._invert&&(u=!u);if(!u)return s();if(i.pending)return n.emit("pending",i),n.emit("test end",i),s();n.emit("test",n.test=i),n.hookDown("beforeEach",function(){n.currentRunnable=n.test,n.runTest(function(e){i=n.test;if(e)return n.fail(i,e),n.emit("test end",i),n.hookUp("afterEach",s);i.state="passed",n.emit("pass",i),n.emit("test end",i),n.hookUp("afterEach",s)})})}var n=this,r=e.tests.slice(),i;this.next=s,s()},Runner.prototype.runSuite=function(e,t){function s(){var t=e.suites[i++];if(!t)return o();r.runSuite(t,s)}function o(){r.suite=e,r.hook("afterAll",function(){r.emit("suite end",e),t()})}var n=this.grepTotal(e),r=this,i=0;debug("run suite %s",e.fullTitle());if(!n)return t();this.emit("suite",this.suite=e),this.hook("beforeAll",function(){r.runTests(e,s)})},Runner.prototype.uncaught=function(e){debug("uncaught exception %s",e.message);var t=this.currentRunnable;if(!t||"failed"==t.state)return;t.clearTimeout(),e.uncaught=!0,this.fail(t,e);if("test"==t.type){this.emit("test end",t),this.hookUp("afterEach",this.next);return}this.emit("end")},Runner.prototype.run=function(e){function n(e){t.uncaught(e)}var t=this,e=e||function(){};return debug("start"),this.on("end",function(){debug("end"),process.removeListener("uncaughtException",n),e(t.failures)}),this.emit("start"),this.runSuite(this.suite,function(){debug("finished running"),t.emit("end")}),process.on("uncaughtException",n),this};